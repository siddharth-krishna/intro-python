function CodeJar(a,b,c={}){function d(){const b=window.getSelection(),c={start:0,end:0,dir:void 0};return n(a,a=>{if(a===b.anchorNode&&a===b.focusNode)return c.start+=b.anchorOffset,c.end+=b.focusOffset,c.dir=b.anchorOffset<=b.focusOffset?"->":"<-","stop";if(a===b.anchorNode){if(c.start+=b.anchorOffset,!c.dir)c.dir="->";else return"stop";}else if(a===b.focusNode)if(c.end+=b.focusOffset,!c.dir)c.dir="<-";else return"stop";a.nodeType===Node.TEXT_NODE&&("->"!=c.dir&&(c.start+=a.nodeValue.length),"<-"!=c.dir&&(c.end+=a.nodeValue.length))}),c}function e(b){const c=window.getSelection();let d,e,f=0,g=0;if(b.dir||(b.dir="->"),0>b.start&&(b.start=0),0>b.end&&(b.end=0),"<-"==b.dir){const{start:a,end:c}=b;b.start=c,b.end=a}let h=0;n(a,a=>{if(a.nodeType===Node.TEXT_NODE){const c=(a.nodeValue||"").length;return h+c>=b.start&&(d||(d=a,f=b.start-h),h+c>=b.end)?(e=a,g=b.end-h,"stop"):void(h+=c)}}),d||(d=a),e||(e=a),"<-"==b.dir&&([d,f,e,g]=[e,g,d,f]),c.setBaseAndExtent(d,f,e,g)}function f(){const b=window.getSelection(),c=b.getRangeAt(0),d=document.createRange();return d.selectNodeContents(a),d.setEnd(c.startContainer,c.startOffset),d.toString()}function g(){const b=window.getSelection(),c=b.getRangeAt(0),d=document.createRange();return d.selectNodeContents(a),d.setStart(c.endContainer,c.endOffset),d.toString()}function h(a){if("Enter"===a.key){const b=f(),c=g();let[h]=t(b),i=h;if(w.indentOn.test(b)&&(i+=w.tab),D?(v(a),r("\n"+i)):0<i.length&&(v(a),r("\n"+i)),i!==h&&"}"===c[0]){const a=d();r("\n"+h),e(a)}}}function i(a){const b=`)]}'"`,c=g(),h=f();if(b.includes(a.key)&&"\\"!==h.substr(h.length-1)&&c.substr(0,1)===a.key){const b=d();v(a),b.start=++b.end,e(b)}else if("([{'\"".includes(a.key)&&"\\"!==h.substr(h.length-1)){const c=d();v(a);const f=a.key+b[`([{'"`.indexOf(a.key)];r(f),c.start=++c.end,e(c)}}function j(a){if("Tab"===a.key)if(v(a),a.shiftKey){const a=f();let[b,c]=t(a);if(0<b.length){const a=d(),f=Math.min(w.tab.length,b.length);e({start:c,end:c+f}),document.execCommand("delete"),a.start-=f,a.end-=f,e(a)}}else r(w.tab)}function k(b){if(p(b)){v(b),B--;const c=A[B];c&&(a.innerHTML=c.html,e(c.pos)),0>B&&(B=0)}if(q(b)){v(b),B++;const c=A[B];c&&(a.innerHTML=c.html,e(c.pos)),B>=A.length&&B--}}function l(){if(!C)return;const b=a.innerHTML,c=d(),e=A[B];if(e&&e.html===b&&e.pos.start===c.start&&e.pos.end===c.end)return;B++,A[B]={html:b,pos:c},A.splice(B+1);300<B&&(B=300,A.splice(0,1))}function m(c){v(c);const f=(c.originalEvent||c).clipboardData.getData("text/plain"),g=d();r(f),b(a),e({start:g.start+f.length,end:g.start+f.length})}function n(a,b){const c=[];a.firstChild&&c.push(a.firstChild);for(let d=c.pop();d&&"stop"!==b(d);)d.nextSibling&&c.push(d.nextSibling),d.firstChild&&c.push(d.firstChild),d=c.pop()}function o(a){return a.metaKey||a.ctrlKey}function p(a){return o(a)&&!a.shiftKey&&"z"===a.key}function q(a){return o(a)&&a.shiftKey&&"z"===a.key}function r(a){a=a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),document.execCommand("insertHTML",!1,a)}function s(a,b){let c=0;return(...d)=>{clearTimeout(c),c=window.setTimeout(()=>a(...d),b)}}function t(a){let b=a.length-1;for(;0<=b&&"\n"!==a[b];)b--;b++;let c=b;for(;c<a.length&&/[ \t]/.test(a[c]);)c++;return[a.substring(b,c)||"",b,c]}function u(){return a.textContent||""}function v(a){a.preventDefault()}const w=Object.assign({tab:"\t",indentOn:/{$/,spellcheck:!1,addClosing:!0},c);let x,y,z=[],A=[],B=-1,C=!1,D=-1<navigator.userAgent.toLowerCase().indexOf("firefox");a.setAttribute("contentEditable",D?"true":"plaintext-only"),a.setAttribute("spellcheck",w.spellcheck?"true":"false"),a.style.outline="none",a.style.overflowWrap="break-word",a.style.overflowY="auto",a.style.resize="vertical",a.style.whiteSpace="pre-wrap",b(a);const E=s(()=>{const c=d();b(a),e(c)},30);let F=!1;const G=a=>!p(a)&&!q(a)&&"Meta"!==a.key&&"Control"!==a.key&&"Alt"!==a.key&&!a.key.startsWith("Arrow"),H=s(a=>{G(a)&&(l(),F=!1)},300),I=(b,c)=>{z.push([b,c]),a.addEventListener(b,c)};return I("keydown",a=>{a.defaultPrevented||(y=u(),h(a),j(a),w.addClosing&&i(a),k(a),G(a)&&!F&&(l(),F=!0))}),I("keyup",a=>{a.defaultPrevented||a.isComposing||(y!==u()&&E(),H(a),x&&x(u()))}),I("focus",()=>{C=!0}),I("blur",()=>{C=!1}),I("paste",a=>{l(),m(a),l(),x&&x(u())}),{updateOptions(a){a=Object.assign(Object.assign({},a),a)},updateCode(c){a.textContent=c,b(a)},onUpdate(a){x=a},toString:u,destroy(){for(let[b,c]of z)a.removeEventListener(b,c)}}}